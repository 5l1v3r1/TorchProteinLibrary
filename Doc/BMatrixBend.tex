
\subsection{Bending angle}
Lets look at the Fig. \ref{Fig:BendingKinematics}. The change of atomic coordinate $\mathbf{r}_j = \mathbf{\widetilde{r}_j} + \mathbf{r_i}$ 
can be expressed using the angular velocity:
$$
\frac{d\mathbf{r}_j}{dt} = [\mathbf{\omega}, \mathbf{\widetilde{r}}_j]
$$

\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{Fig/BendingKinematics.png}
    \caption{The model of bending angle change upon changing an an atom coordinate.}
    \label{Fig:BendingKinematics}
\end{figure}

The angular velocity around the axis in the joint $i$ is the vector perpendicular to this joint and proportional to the change of the angle:
$$
\mathbf{\omega} = [\mathbf{u}, \mathbf{v}] \frac{d\alpha_i}{dt}
$$
where the vectors $\mathbf{u} = \mathbf{r}_i - \mathbf{r}_{i-1}$ and $\mathbf{v} = \mathbf{r}_{i+1} - \mathbf{r}_{i}$ should 
not be parallel (otherwise we chose an arbitrary vector and $\mathbf{u}$). We denote $\mathbf{w} = [\mathbf{u}, \mathbf{v}]$ 
and the changes in angle and coordinates can be written:
$$
\frac{d\mathbf{r}_j}{dt} = [\mathbf{w}, \mathbf{\widetilde{r}}_j] \frac{d\alpha_i}{dt}
$$
Now, lets use the following relation for tripple cross products: 
$[\mathbf{a},[\mathbf{b},\mathbf{c}]] = \mathbf{b} (\mathbf{a}, \mathbf{c}) - \mathbf{c} (\mathbf{a}, \mathbf{b})$
and
$(\mathbf{a},[\mathbf{b},\mathbf{c}]) = (\mathbf{c} [\mathbf{a}, \mathbf{b}]) = (\mathbf{b}, [\mathbf{c}, \mathbf{a}])$.
First we multiply both parts by the cross product:
$$
([\mathbf{w}, \mathbf{\widetilde{r}}_j], \frac{d\mathbf{r}_j}{dt}) = ([\mathbf{w}, \mathbf{\widetilde{r}}_j],
[\mathbf{w}, \mathbf{\widetilde{r}}_j]) \frac{d\alpha_i}{dt}
$$
and the we simplify the right part of the equation:
$$
([\mathbf{w}, \mathbf{\widetilde{r}}_j], [\mathbf{w}, \mathbf{\widetilde{r}}_j]) = (\mathbf{r}_j, [[\mathbf{w}, \mathbf{\widetilde{r}}_j], \mathbf{w}]) =
(\mathbf{\widetilde{r}}_j, \mathbf{\widetilde{r}}_j(\mathbf{w},\mathbf{w}) - \mathbf{w}(\mathbf{w},\mathbf{\widetilde{r}}_j))
$$
Taking into account that we normalized the vector $\mathbf{w}$ we write:
$$
([\mathbf{w}, \mathbf{\widetilde{r}}_j], \frac{d\mathbf{r}_j}{dt}) = \left( |\mathbf{\widetilde{r}}_j|^2 - 
(\mathbf{\widetilde{r}}_j,\mathbf{w})^2 \right) \frac{d\alpha_i}{dt}
$$
The expression on the right is the square of torque. Now we can take individual components of the derivatives and divide them:
$$
\frac{d\alpha_i^k}{dr^k_j} = \frac{[\mathbf{w}, \mathbf{\widetilde{r}}_j]_k}{|\mathbf{\widetilde{r}}_j|^2 - (\mathbf{\widetilde{r}}_j,\mathbf{w})^2}
$$
Now special care should be payed to the case when $\mathbf{\widetilde{r}}_j = \mathbf{0}$. 
In this case we take $\mathbf{\widetilde{r}} = \mathbf{v}$ for the right body and 
$\mathbf{\widetilde{r}} = \mathbf{u}$ for the left one. Also, 
the direction of the vector $\mathbf{w}$ depends on the body, where point $j$ is located. 
Altogether these two body motions can be expressed like this:
$$
\frac{d\alpha_i^k}{dr^k_j} = \frac{ -h_{ij}[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2} + 
\frac{ h_{ji}[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2}
$$ where
$$
h_{ab} = \left \{ \begin{array}{lll}
+1  & a\geq b \\
0  & a<b
\end{array}
\right.
$$

Or algorithmically:
\begin{algorithm}
    \caption{Bending matrix computation}
    \label{alg:BendingAlgorithm}
    \begin{algorithmic}
        \FOR {$i = 0 \dots N$ scanning bending angles} 
            \FOR {$j = 0 \dots N+2$ scanning atoms} 
                \IF {$j < i+1 $ (atom $i+1$ corresponds to the angle $i$, left body)}
                    \STATE $\mathbf{\widetilde{r}} = \mathbf{r}_j - \mathbf{r}_{i+1}$
                    \STATE $\mathbf{w} = [\mathbf{r}_{i+2} - \mathbf{r}_{i+1}, \mathbf{r}_{i} - \mathbf{r}_{i+1}]$
                    \STATE $\frac{d\alpha_i^k}{dr^k_j} = \frac{[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2}$
                \ELSIF {$j > i+1 $ (atom in the right body)}
                    \STATE $\mathbf{\widetilde{r}} = \mathbf{r}_j - \mathbf{r}_{i+1}$
                    \STATE $\mathbf{w} = [\mathbf{r}_{i} - \mathbf{r}_{i+1}, \mathbf{r}_{i+2} - \mathbf{r}_{i+1}]$
                    \STATE $\frac{d\alpha_i^k}{dr^k_j} = \frac{[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2}$
                \ELSIF {$j = i+1$ (atom is the joint center) }
                    \STATE Left body
                    \STATE $\mathbf{\widetilde{r}} = \mathbf{r}_{i+1} - \mathbf{r}_{i}$
                    \STATE $w = [\mathbf{r}_{i} - \mathbf{r}_{i+1}, \mathbf{r}_{i+2} - \mathbf{r}_{i+1}]$
                    \STATE $\frac{d\alpha_i^k}{dr^k_j} = \frac{[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2}$
                    \STATE Right body
                    \STATE $\mathbf{\widetilde{r}} = \mathbf{r}_{i+1} - \mathbf{r}_{i+2}$
                    \STATE $w = [\mathbf{r}_{i+2} - \mathbf{r}_{i+1}, \mathbf{r}_{i} - \mathbf{r}_{i+1}]$
                    \STATE $\frac{d\alpha_i^k}{dr^k_j} += \frac{[\mathbf{w},\mathbf{\widetilde{r}}]_k}{|\mathbf{\widetilde{r}}|^2 - (\mathbf{\widetilde{r}},\mathbf{w})^2}$
                \ENDIF               
            \ENDFOR
        \ENDFOR
    \end{algorithmic}
\end{algorithm}
